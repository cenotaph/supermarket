!!! 5
%html
  %head
    %meta{:content => "width=device-width, initial-scale=1.0", :name => "viewport"}
    %title= content_for?(:title) ? yield(:title) : "AIM project"
    %meta{:content => content_for?(:description) ? yield(:description) : "Supermarket", :name => "description"}
    = stylesheet_link_tag :application
    = stylesheet_link_tag theme_stylesheet_path(:application), :media => :screen
    = javascript_include_tag theme_javascript_path(:application)
    %script{:src => "http://maps.google.com/maps/api/js?sensor=false", :type => "text/javascript"}
    = csrf_meta_tags
    = yield(:head)    
    %link{:href => "/images/favicon.ico", :rel => "shortcut icon"}/
    %link{:href => "/images/apple-touch-icon.png", :rel => "apple-touch-icon"}/
    %link{:href => "/images/apple-touch-icon-72x72.png", :rel => "apple-touch-icon", :sizes => "72x72"}/
    %link{:href => "/images/apple-touch-icon-114x114.png", :rel => "apple-touch-icon", :sizes => "114x114"}/
  %body{:onload => 'initialize()'}
    .container
      .sixteen.columns.header
        .languages
 
          - I18n.available_locales.each do |locale|
            - if session[:locale].nil?
              - if locale == :en
                %b= locale.to_s
              - else
                %a( href="/#{locale.to_s}/" )= locale.to_s
            - else
              - if session[:locale] == locale.code
                %b= locale.code
              - else
                %a( href="/#{locale.code}/" )= locale.title

        .login_stuff
          - if current_user
            You are logged in as 
            = current_user.name
            = link_to '[Logout]', '/logout'
            .meta
              - if current_user.space.nil?
                You have not yet submitted your organisation's information.
                = link_to 'Submit it now!', '/my_organisation'
              - else
                Your organisation:
                - unless current_user.space.business_name.blank?
                  = current_user.space.business_name
                .meta
                  - unless current_user.space.logo.blank?
                    = image_tag current_user.space.logo.url(:tiny), :style => "float: left; margin-right: 5px"
                  - if current_user.space.approved
                    .sidebar_tiny= link_to 'View your profile', '/spaces/' + current_user.space.best_id
                  - else
                    .sidebar_tiny= current_user.space.percent_complete + "% complete"
                  .sidebar_tiny= link_to 'Edit your details', '/my_organisation'
            - if current_user.admin?
              = link_to '[Admin setup]', '/cms'
          - else 
            .login_text
              You are not logged in.
            .login_text
              = t :connect_instantly
              = link_to 'Facebook', '/auth/facebook'
              |
              = link_to 'Twitter', '/auth/twitter'
            
        %h1
          %a.button_to{:href => '/'}
            = image_tag(theme_image_path('aim_logo.png'))
          - Page.by_subsite(@subsite.id).published.each do |page|
            = button_to page.title, page, :method => :get
        .subtitle= t "aim.header_text"
      .sixteen.columns.search{:style => "display: " + (@nofilters.nil? ? 'inline' : 'none')}

        .search_dropdown.eight.columns.alpha
          %form{:action => "/browse/search", :method => "post"}
            #menu.two.columns.alpha
              .search_title= t :search_by
              %select{:name => :search_filter}
                %option{:value => :name}= t :name
                %option{:value => :activities}= t :activities
                %option{:value => :location}= t :location
            .six.columns.alpha
              %input.shadow{:type => :text, :name => :search_term}
              %input{:type => :submit, :value => ''}
        .filter_info.eight.columns.omega
          .search_title= t :showing
          .quotes
            - if @quotes
              = "\"" + @quotes + "\""
            - else
              All spaces
          .eight.omega.columns{:style => "display: " + (@nofilters.nil? ? 'inline' : 'none')}
            .filter_toggle
              %i.icon-chevron-sign-right
              %a{:href => '#', :onClick => '$(".filter_container").slideToggle();'}= t "aim.toggle_filters"
              
      .sixteen.columns.filter_container{:style => "display: " + (@closedfilters.nil? && @nofilters.nil? ? 'inline' : 'none')}
        .five.alpha.columns.filter_column
          .title= t :location
          #tree
            %ul
              - ISO3166::Country::Data.group_by{|x| x.last["region"]}.each do |region|
                - next if region.first.blank?
                - next if @tree[region.first].nil?
                - next if @tree[region.first].flatten.delete_if{|x| x.class == String}.nil?

                %li{:id => region.first}
                  = link_to region.first + " (#{@tree[region.first].to_enum(:flat_each).collect {|k, v| [k,v] }.flatten.delete_if{|x| x.class == String }.size})", '#'
                  %ul
                    - region.last.group_by{|x| x.last['subregion'] }.each do |subregion|
                      - next if subregion.first.blank?
                      - next if @tree[region.first][subregion.first].nil?
                      %li
                        = link_to subregion.first + " (#{@tree[region.first][subregion.first].to_enum(:flat_each).collect {|k, v| [k,v] }.flatten.delete_if{|x| x.class == String }.size})", '#'
                        %ul
                          - subregion.last.sort_by{|x| x.last['name'] }.each do |country|
                            - next if country.first.blank?
                            - next if @tree[region.first][subregion.first][country.first.downcase].nil?
                            %li= link_to country.last['name'] + " (#{@tree[region.first][subregion.first][country.first.downcase].size})", '/browse?by_country=' + country.first
        .five.alpha.columns.filter_column{:style => "border-left: 1px dotted #000;"}
          / .title= t.activities
          / %ul
          /   - Activity.all.each do |activity|
          /     %li
          /       = link_to activity.translate(:name, session[:locale]), '/browse/activity/' + activity.id.to_s
          /       - unless activity.spaces.delete_if{|x| x.approved == false}.empty?
          /         = "(#{activity.spaces.size})"
          .title= t "aim.type_of_initiative"
          %ul
            - Businesstype.all.each do |bt|
              %li
                = link_to bt.name, '/browse/business_type/' + bt.id.to_s
                - unless bt.spaces.delete_if{|x| x.approved == false}.empty?
                  = "(#{bt.spaces.size})"
        .five.alpha.columns.filter_column.last                  
          .title= t "aim.organisation_structure"
          %ul
            - Organisationtype.all.each do |ot|
              %li
                = link_to ot.name, '/browse/organisation_type/' + ot.id.to_s
                - unless ot.spaces.delete_if{|x| x.approved == false}.empty?
                  = "(#{ot.spaces.size})"
          .title= t "aim.exhibition_space_type"
          %ul
            - Exhibitionspacetype.all.each do |est|
              %li
                = link_to est.name, '/browse/exhibitionspace_type/' + est.id.to_s
                - unless est.spaces.delete_if{|x| x.approved == false}.empty?
                  = "(#{est.spaces.size})"
                              
      .sixteen.columns= yield 
      .footer.sixteen.columns
        .five.alpha.columns
          %label.sub= t :copyright_notice
        .five.columns.alpha
          / %label= t.subscribe
          / %input.shadow{:type => :text}
          &nbsp;
        .four.columns.alpha
          %label= t :contact
          %p
            Contact information here.
          %label= t :press
          %p
            Press info here
        .two.columns.omega
          %label= t :follow_us
          .facebook
            %a{:href => "need facebook link"}
              = image_tag theme_image_path('facebook_icon.png')
          .twitter
            %a{:href => "need twitter link"}
              = image_tag theme_image_path('twitter_icon.png')
      .support.sixteen.columns
        = t :supporters
        = image_tag theme_image_path('kknord.png')
        = image_tag theme_image_path('supermarket_no_year_black.png')
        
  :javascript
    $(document).ready(function() {

      $('#tree').jstree({
        "themes" : {
          "theme" :  "apple",
          "dots" : true,
          "icons" : false
          },
        core : { "initially_open" : [ "Europe" ] },
        plugins : ["themes", "html_data"]
      });
      #{yield :jquery}
    });
